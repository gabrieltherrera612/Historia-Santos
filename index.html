<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Timeline de Apariciones y Santos</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Dancing+Script&display=swap" rel="stylesheet">
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background: #f5f6fa;
  }

  /* Titulo */
  #titulo-timeline {
    text-align: center;
    font-family: 'Dancing Script', cursive;
    font-size: 28px; /* un poco m치s grande */
    font-weight: normal;
    margin: 20px 0;
    color: #333;
    background: rgba(135,206,250,0.3);
    padding: 12px;
    border-radius: 10px;
  }

  /* BLOQUE 1: Filtros + buscador */
  #panel-superior {
    display: flex;
    gap: 15px;
    padding: 15px;
    background: #fff;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    align-items: center;
    flex-wrap: wrap;
  }

  #filtros {
    display: flex;
    gap: 15px;
    flex-shrink: 0;
    font-size: 18px; /* tama침o letra aumentado */
  }

  #filtros input[type="checkbox"] {
    width: 20px; /* box m치s grande */
    height: 20px;
  }

  #buscador {
    flex: 1;
    max-width: 450px;
    padding: 12px; /* box m치s grande */
    font-size: 18px; /* letra m치s grande */
    border-radius: 6px;
    border: 1px solid #ccc;
  }

  /* Timeline */
  #timeline {
    margin: 10px;
    height: 320px; /* timeline m치s alto */
    font-size: 18px; /* texto m치s grande */
  }

  /* Detalle evento + imagen combinada */
  #detalle-seleccion {
    margin: 10px;
    background: #fff;
    padding: 30px; /* m치s espacio */
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    display: none;
  }

  #detalle-seleccion h3 { margin-top: 0; font-size: 26px; }

  #detalle-content {
    text-align: justify;
    font-size: 18px; /* texto m치s grande */
  }

  #detalle-content img {
    float: left;
    width: 160px;
    margin-right: 15px;
    margin-bottom: 10px;
    border-radius: 10px;
  }

  #detalle-qr { margin-top: 15px; clear: both; }

  .evento { display: flex; align-items: center; gap: 5px; font-size: 18px; } /* m치s grande en timeline */
  .evento img {
    width: 40px;
    height: 40px;
    object-fit: cover;
    border-radius: 50%;
    border: 2px solid #ccc;
  }

  .evento.Jesus { color: #d9534f; font-weight: bold; }
  .evento.Virgen { color: #337ab7; }
  .evento.Santo { color: #5cb85c; }

  @media (max-width: 768px) {
    #detalle-content img {
      float: none;
      display: block;
      width: 80%;
      margin: 0 auto 15px auto;
    }
    #buscador { max-width: 100%; font-size: 18px; padding: 12px; }
    #timeline { height: 250px; font-size: 18px; }
  }
</style>
</head>
<body>

<div id="titulo-timeline">LINEA DE TIEMPO</div>

<div id="panel-superior">
  <div id="filtros">
    <label><input type="checkbox" id="filtro-jesus" checked> Jesus</label>
    <label><input type="checkbox" id="filtro-virgen" checked> Virgen</label>
    <label><input type="checkbox" id="filtro-santo" checked> Santo</label>
  </div>
  <input type="text" id="buscador" placeholder="Buscar... (ej: francis, asis, guadalupe)" />
</div>

<div id="timeline"></div>

<div id="detalle-seleccion">
  <h3 id="detalle-title"></h3>
  <p id="detalle-fecha"></p>
  <div id="detalle-content"></div>
  <div id="detalle-qr"></div>
</div>

<script>
  const container = document.getElementById("timeline");
  const dataset = new vis.DataSet([]);
  let allData = [];

  const options = {
    start: new Date(1000,0,1),
    end: new Date(2000,11,31),
    editable: false,
    template: function(item) {
      return `<div class="evento ${item.categoria}">
          <img src="${item.img}" alt="${item.title}" />
          <span>${item.title}</span>
        </div>`;
    },
    tooltip: { followMouse: true }
  };

  const timeline = new vis.Timeline(container, dataset, options);

  function limpiarTexto(texto) {
    if (!texto) return "";
    return texto.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
  }

  // funci칩n que muestra el detalle a partir del id del item
  function mostrarDetalleById(idItem) {
    const item = dataset.get(idItem);
    if (!item) return;

    document.getElementById("detalle-seleccion").style.display = "block";
    document.getElementById("detalle-title").textContent = item.title;
    document.getElementById("detalle-fecha").textContent = item.start;

    let contenidoHTML = `<img src="${item.img}" alt="${item.title}">${item.content}`;

    if (item.fuente) {
      contenidoHTML += `<p><strong>Fuente:</strong> <a href="${item.fuente}" target="_blank">${item.fuente}</a></p>`;
    }

    // Lista simple de PDFs (icono + nombre bonito) y descarga con nombre limpio
    if (item.pdfs && Array.isArray(item.pdfs) && item.pdfs.length > 0) {
      contenidoHTML += `<h3 style="margin-top:25px;">游늯 Documentos PDF</h3>`;
      item.pdfs.forEach((pdf) => {
        const nombrePDF = pdf.split("/").pop();
        let nombreLimpio = nombrePDF.replace(/_/g, " ").replace(/\.pdf$/i, "").trim();
        nombreLimpio = nombreLimpio.replace(/\b\w/g, l => l.toUpperCase());

        contenidoHTML += `
          <div style="display:flex; align-items:center; margin-bottom:12px;">
            <img src="https://raw.githubusercontent.com/feathericons/feather/master/icons/file.svg?sanitize=true"
                style="width:40px; margin-right:12px; filter: invert(27%) sepia(93%) saturate(7473%) hue-rotate(354deg) brightness(92%) contrast(113%);">
            <a href="${pdf}" download="${nombreLimpio}.pdf"
               style="font-size:18px; font-weight:bold; text-decoration:none; color:#0056b3;">
               ${nombreLimpio}
            </a>
          </div>
        `;
      });
    }

    document.getElementById("detalle-content").innerHTML = contenidoHTML;

    // generar QR para este santo (URL con hash)
    const qrDiv = document.getElementById("detalle-qr");
    qrDiv.innerHTML = "";
    const qrURL = `https://gabrieltherrera612.github.io/Historia-Santos/#${limpiarTexto(item.title).replace(/\s+/g,'-')}`;
    new QRCode(qrDiv, { text: qrURL, width: 180, height: 180 });

    // ocultar teclado en m칩viles
    document.getElementById("buscador").blur();
  }

  function renderizar() {
    const jesus = document.getElementById("filtro-jesus").checked;
    const virgen = document.getElementById("filtro-virgen").checked;
    const santo = document.getElementById("filtro-santo").checked;
    const busqueda = limpiarTexto(document.getElementById("buscador").value);

    const itemsFiltrados = allData.filter(item => {
      const categoriaOK = (item.categoria === "Jesus" && jesus) ||
                          (item.categoria === "Virgen" && virgen) ||
                          (item.categoria === "Santo" && santo);
      const textoOK = limpiarTexto(item.title).includes(busqueda);
      return categoriaOK && textoOK;
    });

    dataset.clear();
    dataset.add(itemsFiltrados);

    if (itemsFiltrados.length > 0) {
      // centrar y seleccionar primer resultado
      const primerId = itemsFiltrados[0].id;
      timeline.focus(primerId, { animation: { duration: 500 } });
      timeline.setSelection(primerId);

      // mostrar detalle inmediatamente
      mostrarDetalleById(primerId);
    } else {
      // ocultar panel si no hay resultados
      document.getElementById("detalle-seleccion").style.display = "none";
    }
  }

  // Cargar datos
  fetch("eventos.json")
    .then(res => res.json())
    .then(data => {
      allData = data;
      dataset.add(allData);

      // Si hay hash en la URL (por QR), buscar el item y mostrarlo
      const hash = window.location.hash.substr(1);
      if (hash) {
        const itemHash = allData.find(i => limpiarTexto(i.title).replace(/\s+/g,'-') === hash);
        if (itemHash) {
          timeline.focus(itemHash.id, { animation: { duration: 500 } });
          timeline.setSelection(itemHash.id);
          mostrarDetalleById(itemHash.id);
        }
      }
    })
    .catch(err => console.error("Error cargando eventos:", err));

  // listeners filtro + buscador
  document.getElementById("filtro-jesus").addEventListener("change", renderizar);
  document.getElementById("filtro-virgen").addEventListener("change", renderizar);
  document.getElementById("filtro-santo").addEventListener("change", renderizar);
  document.getElementById("buscador").addEventListener("input", renderizar);

  // cuando el usuario selecciona en el timeline (clic)
  timeline.on("select", function(props) {
    if (props.items.length > 0) {
      // props.items[0] puede ser id o el item id (vis usa id)
      const idSeleccion = props.items[0];
      mostrarDetalleById(idSeleccion);
    }
  });
</script>

</body>
</html>